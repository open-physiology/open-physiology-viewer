version: "1.0"
stages:
  - "clone"
  - "build"
  - "deploy"
steps:
  clone:
    stage: "clone"
    title: "Cloning Apinatomy"
    type: "git-clone"
    repo: "metacell/open-physiology-viewer"
    revision: "${{CF_BRANCH}}"
  build:
    stage: "build"
    title: "Building Apinatomy"
    type: "build"
    image_name: "apinatomy"
    tag: "${{CF_BUILD_ID}}"
    dockerfile: Dockerfile
    working_directory: ./open-physiology-viewer
    buildkit: true    
    registry: "${{CODEFRESH_REGISTRY}}"
  test_build:
    stage: test
    type: build
    title: Building Apinatomy test image
    image_name: apinatomy_test
    working_directory: ./open-physiology-viewer
    dockerfile: Dockerfile.testing
    buildkit: true
  test:
    type: composition
    title: Running Tests
    description: Temporary test environment
    stage: test
    working_directory: ./open-physiology-viewer
    composition:
      version: '2'
      services:
        app:
          image: '${{build}}'
          working_dir: /home/pptruser
          ports:
            - 80
    composition_candidates:
      test:
        image: '${{test_build}}'
        working_dir: /home/pptruser
        command: bash -c 'ls -l && npm run keast_snapshot_test'
